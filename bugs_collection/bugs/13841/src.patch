diff --git a/buggy/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java b/fixed/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java
index f44e2c666..b996cefc1 100644
--- a/buggy/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java
+++ b/fixed/presto-main/src/main/java/com/facebook/presto/execution/SqlStageExecution.java
@@ -581,7 +581,7 @@ public final class SqlStageExecution
                 }
 
                 schedulingComplete.set(DateTime.now());
-                stageState.set(StageState.SCHEDULED);
+                stageState.compareAndSet(StageState.SCHEDULING, StageState.SCHEDULED);
 
                 // add the missing exchanges output buffers
                 updateNewExchangesAndBuffers(true);
